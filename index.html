<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Lista de Productos - USD a Bs</title>
<style>
.seleccionado {
    background-color: #c4f7c3 !important;
}
body.tema-oscuro .seleccionado {
    background-color: #32ff7e !important;  /* Verde neÃ³n fuerte */
    color:black !important; /* Para que el texto se vea perfecto */
}
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f3f6ff;
    }
    h2 {
        text-align: center;
        color: #2c4cff;
    }
    input, button {
        padding: 8px;
        margin: 5px;
        border-radius: 5px;
        border: 1px solid #999;
    }
    button {
        background: #2c4cff;
        color: white;
        cursor: pointer;
    }
    table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
    }
    th, td {
        border: 1px solid #ccc;
        padding: 10px;
        text-align: center;
    }
    th {
        background: #dfe3ff;
    }
    .delete-btn {
        background: red;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        border: none;
    }
    .edit-btn {
        background: #ffa500;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        border: none;
        margin-right: 5px;
    }
    #ordenadores {
    position: fixed;
    top: 15px;
    right: 15px;
    display: flex;
    gap: 10px;
}
#ordenadores button {
    background: #2c4cff;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    cursor: pointer;
}
.encontrado {
    background-color: #c4f7c3 !important;
}
body.tema-oscuro {
    background:#0f1320;
    color:white;
}

body.tema-oscuro input,
body.tema-oscuro button {
    background:#1d2235;
    color:white;
    border:1px solid #555;
}

body.tema-oscuro table th {
    background:#2b3250;
}

body.tema-oscuro table td {
    background:#1a1f33;
    color:white;
}

body.tema-oscuro .delete-btn {
    background:#bb2d2d;
}

body.tema-oscuro .edit-btn {
    background:#d88a00;
}

body.tema-oscuro #ordenadores button {
    background:#1d60ff;
}
body.tema-oscuro tr.seleccionado td {
    background-color: #32ff7e !important;
    color: black !important;
}

body.tema-oscuro #totales {
    color: #32ff7e;
}
body.tema-oscuro #totales {
    color: #32ff7e;
}
body.tema-oscuro #modal-cantidad div {
    background:#1f2433;
    color:white;
}
body.tema-oscuro #modal-cantidad button {
    background:#2b3250;
    color:white;
    border:none;
}
</style>
</head>

<body>

<h2>Lista de Productos USD â†’ Bs</h2>

<button id="tema-btn" onclick="toggleTema()" 
style="position:fixed; top:15px; left:15px; z-index:999; padding:8px 12px; border:none; 
border-radius:8px; background:#2c4cff; color:white; cursor:pointer;">
ðŸŒ™
</button>

<label>Tasa del dÃ³lar (USD â†’ Bs): </label>
<input type="number" id="tasa" placeholder="Ej: 40" oninput="guardarTasa(); actualizarPrecios()" />

<div id="fila-superior" style="display:flex; align-items:center; justify-content:space-between; margin-top:10px;">
    
    <div></div> <!-- espacio vacÃ­o para alinear -->
    
    <div id="totales" style="font-weight:bold; font-size:16px;">
        TOTAL: USD <span id="total-usd">0.00</span> / Bs <span id="total-bs">0.00</span>
    </div>
</div>

<h3>Agregar producto</h3>
<input type="text" id="busqueda" placeholder="Buscar producto..." oninput="buscarProducto()" style="float:right; margin-top:10px;">
<div id="ordenadores">
    <button onclick="ordenarNombre()">Ordenar A-Z</button>
    <button onclick="ordenarPrecio()">Ordenar por Precio</button>
</div>
<input type="text" id="nombre" placeholder="Nombre del producto" />
<input type="number" id="precio" placeholder="Precio en USD" />
<button onclick="agregarProducto()">Agregar</button>

<table id="tabla">
    <thead>
        <tr>
            <th>Producto</th>
            <th>Precio USD</th>
            <th>Precio Bs</th>
            <th>AcciÃ³n</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
let productos = []; // ARRAY REAL DE PRODUCTOS

// Guardar lista en localStorage
function guardarProductos() {
    localStorage.setItem("productos", JSON.stringify(productos));
}

// Cargar productos guardados al abrir
function cargarProductos() {
    let guardados = JSON.parse(localStorage.getItem("productos") || "[]");
    productos = guardados;
    renderizarTabla();
}

// Renderizar toda la tabla desde cero
function renderizarTabla() {
    let tabla = document.querySelector("#tabla tbody");
    tabla.innerHTML = "";

    productos.forEach((prod, index) => {
        // Mostrar cantidad si existe (atributo cant)
        let cant = prod.cant || 1;
        let fila = document.createElement("tr");
        if (cant > 1) fila.setAttribute("data-cant", cant);

        fila.innerHTML = `
            <td>${prod.nombre}${cant > 1 ? ' (x' + cant + ')' : ''}</td>
            <td class="usd">${prod.usd}</td>
            <td class="bs"></td>
            <td>
                <button class="edit-btn" onclick="editarProducto(${index})">Editar</button>
                <button class="delete-btn" onclick="eliminarProducto(${index})">X</button>
            </td>
        `;

        tabla.appendChild(fila);
    });

    actualizarPrecios();
    activarSeleccionFila();
    activarLongPress();
}

// Guardar tasa
function guardarTasa() {
    let tasa = document.getElementById("tasa").value;
    localStorage.setItem("tasaDolar", tasa);
}

// Agregar producto
function agregarProducto() {
    let nombre = document.getElementById("nombre").value.trim();
    let precioUSD = parseFloat(document.getElementById("precio").value);

    if (!nombre || isNaN(precioUSD)) {
        alert("Ingresa nombre y precio correcto");
        return;
    }

    productos.push({ nombre: nombre, usd: precioUSD, cant: 1 });
    guardarProductos();
    renderizarTabla();

    document.getElementById("nombre").value = "";
    document.getElementById("precio").value = "";
}

// Eliminar producto por Ã­ndice
function eliminarProducto(index) {
    productos.splice(index, 1);
    guardarProductos();
    renderizarTabla();
}

// Editar producto por Ã­ndice
function editarProducto(index) {
    let prod = productos[index];

    let nuevoNombre = prompt("Nuevo nombre del producto:", prod.nombre);
    if (nuevoNombre === null || nuevoNombre.trim() === "") return;

    let nuevoPrecio = prompt("Nuevo precio USD:", prod.usd);
    nuevoPrecio = parseFloat(nuevoPrecio);
    if (isNaN(nuevoPrecio)) return;

    productos[index] = { nombre: nuevoNombre.trim(), usd: nuevoPrecio, cant: prod.cant || 1 };

    guardarProductos();
    renderizarTabla();
}

// Actualizar precios Bs (y recalcular total)
function actualizarPrecios() {
    let tasa = parseFloat(localStorage.getItem("tasaDolar")) || parseFloat(document.getElementById("tasa").value);

    let filas = document.querySelectorAll("#tabla tbody tr");
    filas.forEach(fila => {
        let precioUSD = parseFloat(fila.querySelector(".usd").textContent);
        let celdaBS = fila.querySelector(".bs");

        if (!isNaN(tasa)) {
            celdaBS.textContent = (precioUSD * tasa).toFixed(2);
        } else {
            celdaBS.textContent = "";
        }
    });
    calcularTotal();
}

// ORDENAR POR NOMBRE
function ordenarNombre() {
    productos.sort((a, b) => a.nombre.localeCompare(b.nombre));
    guardarProductos();
    renderizarTabla();
}

// ORDENAR POR PRECIO
function ordenarPrecio() {
    productos.sort((a, b) => a.usd - b.usd);
    guardarProductos();
    renderizarTabla();
}

// Buscar producto (resalta con clase 'encontrado')
function buscarProducto() {
    let texto = document.getElementById("busqueda").value.toLowerCase();
    let filas = document.querySelectorAll("#tabla tbody tr");

    filas.forEach(fila => {
        let nombre = fila.children[0].textContent.toLowerCase();

        fila.classList.remove("encontrado");

        if (texto !== "" && nombre.includes(texto)) {
            fila.classList.add("encontrado");
        }
    });
}

// Toggle tema
function toggleTema() {
    document.body.classList.toggle("tema-oscuro");

    let btn = document.getElementById("tema-btn");
    if (document.body.classList.contains("tema-oscuro")) {
        btn.textContent = "â˜€ï¸";
        localStorage.setItem("tema", "oscuro");
    } else {
        btn.textContent = "ðŸŒ™";
        localStorage.setItem("tema", "claro");
    }
}

// Cargar tema guardado
function aplicarTemaGuardado() {
    let temaGuardado = localStorage.getItem("tema");
    if (temaGuardado === "oscuro") {
        document.body.classList.add("tema-oscuro");
        let b = document.getElementById("tema-btn");
        if (b) b.textContent = "â˜€ï¸";
    }
}

// SELECCIÃ“N de filas (clic simple) â€” ahora permite selecciÃ³n mÃºltiple y toggle
function activarSeleccionFila() {
    let filas = document.querySelectorAll("#tabla tbody tr");

    filas.forEach((fila, idx) => {
        fila.onclick = () => {
            if (fila.classList.contains("seleccionado")) {
                fila.classList.remove("seleccionado");
                calcularTotal();
                return;
            }

            fila.classList.add("seleccionado");
            calcularTotal();
        };
    });
}

// CALCULAR total (toma en cuenta cantidad por fila: data-cant o productos[].cant)
function calcularTotal() {
    let totalUSD = 0;
    let filas = document.querySelectorAll("#tabla tbody tr");

    filas.forEach((fila, i) => {
        if (fila.classList.contains("seleccionado")) {
            let precio = parseFloat(fila.querySelector(".usd").textContent);
            // Prioriza atributo data-cant en fila, si no existe busca en productos por el texto (mejor usar productos array)
            let cant = parseInt(fila.getAttribute("data-cant")) || (productos[i] && productos[i].cant) || 1;
            if (!isNaN(precio)) totalUSD += precio * cant;
        }
    });

    let tasa = parseFloat(localStorage.getItem("tasaDolar")) || parseFloat(document.getElementById("tasa").value);
    let totalBS = isNaN(tasa) ? 0 : totalUSD * tasa;

    document.getElementById("total-usd").textContent = totalUSD.toFixed(2);
    document.getElementById("total-bs").textContent = totalBS.toFixed(2);
}

// VARIABLES Y FUNCIONES PARA EL MODAL (long press)
let filaActual = null;
let cantidadActual = 1;

function activarLongPress() {
    let filas = document.querySelectorAll("#tabla tbody tr");

    filas.forEach((fila, index) => {
        // Limpia data-cant desde productos array para mantener consistencia
        if (productos[index] && productos[index].cant) {
            fila.setAttribute("data-cant", productos[index].cant);
        }

        let timer;

        // soporta touch y click largo con mouse
        fila.addEventListener("touchstart", () => {
            timer = setTimeout(() => {
                abrirModalCantidad(fila, index);
            }, 500);
        });
        fila.addEventListener("touchend", () => clearTimeout(timer));

        // Para escritorio / pruebas con mouse
        fila.addEventListener("mousedown", () => {
            timer = setTimeout(() => {
                abrirModalCantidad(fila, index);
            }, 700);
        });
        fila.addEventListener("mouseup", () => clearTimeout(timer));
        fila.addEventListener("mouseleave", () => clearTimeout(timer));
    });
}

function abrirModalCantidad(fila, index) {
    filaActual = fila;
    cantidadActual = parseInt(fila.getAttribute("data-cant")) || (productos[index] && productos[index].cant) || 1;
    document.getElementById("cantidad-valor").textContent = cantidadActual;
    document.getElementById("modal-cantidad").style.display = "flex";
    // guardar Ã­ndice en modal para actualizar productos array al aceptar
    document.getElementById("modal-cantidad").setAttribute("data-index", index);
}

// Inicializar: atar botones del modal y cargar datos
window.onload = function() {
    aplicarTemaGuardado();
    cargarTasa();
    cargarProductos();

    // Atar botones del modal (con seguridad: ahora ya existen en DOM)
    let btnMenos = document.getElementById("menos");
    let btnMas = document.getElementById("mas");
    let btnAceptar = document.getElementById("aceptar-cantidad");

    if (btnMenos) {
        btnMenos.onclick = () => {
            if (cantidadActual > 1) cantidadActual--;
            document.getElementById("cantidad-valor").textContent = cantidadActual;
        };
    }
    if (btnMas) {
        btnMas.onclick = () => {
            cantidadActual++;
            document.getElementById("cantidad-valor").textContent = cantidadActual;
        };
    }
    if (btnAceptar) {
        btnAceptar.onclick = () => {
            if (filaActual) {
                filaActual.setAttribute("data-cant", cantidadActual);

                // Actualizar tambiÃ©n en el array 'productos' para persistir la cantidad
                let idx = parseInt(document.getElementById("modal-cantidad").getAttribute("data-index"));
                if (!isNaN(idx) && productos[idx]) {
                    productos[idx].cant = cantidadActual;
                    guardarProductos();
                }

                filaActual.classList.add("seleccionado");
            }
            document.getElementById("modal-cantidad").style.display = "none";
            calcularTotal();
            renderizarTabla(); // para mostrar "(xN)" al lado del nombre
        };
    }

    // Cerrar modal si clic fuera (mejora UX)
    let modal = document.getElementById("modal-cantidad");
    if (modal) {
        modal.addEventListener("click", (e) => {
            if (e.target === modal) {
                modal.style.display = "none";
            }
        });
    }
};
</script>
<!-- MODAL DE CANTIDAD -->
<div id="modal-cantidad" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
    
    <div style="background:white; padding:20px; border-radius:12px; width:260px; text-align:center;">
        <h3>Selecciona cantidad</h3>

        <div style="display:flex; justify-content:center; align-items:center; margin:15px 0;">
            <button id="menos" style="width:40px; height:40px; font-size:20px;">âˆ’</button>

            <span id="cantidad-valor" style="margin:0 20px; font-size:20px;">1</span>

            <button id="mas" style="width:40px; height:40px; font-size:20px;">+</button>
        </div>

        <button id="aceptar-cantidad" 
                style="padding:10px 20px; border:none; background:#2c4cff; color:white; border-radius:8px;">
            Aceptar
        </button>
    </div>
</div>
</body>
    </html>
